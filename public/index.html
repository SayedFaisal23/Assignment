<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyTaxi App</title>
  <style>
    body { font-family: Arial; margin: 2rem; background: #f9f9f9; }
    section { display: none; padding: 1rem; background: #fff; margin-bottom: 2rem; border-radius: 8px; box-shadow: 0 0 8px rgba(0,0,0,0.1); }
    input, button { display: block; margin: 8px 0; padding: 8px; width: 100%; max-width: 300px; }
    h2 { margin-top: 0; }
  </style>
</head>
<body>

<!-- LOGIN / REGISTER SECTION -->
<section id="auth-section" style="display: block;">
  <h2>Welcome to MyTaxi</h2>

  <div>
    <h3>Login</h3>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPassword" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>

  <hr>

  <div>
    <h3>Register</h3>
    <input id="regName" placeholder="Name" />
    <input id="regAge" type="number" placeholder="Age" />
    <input id="regEmail" type="email" placeholder="Email" />
    <input id="regPassword" type="password" placeholder="Password" />
    <label><input type="checkbox" id="regAdmin" /> Admin</label>
    <button onclick="register()">Register</button>
  </div>
</section>

<!-- USER DASHBOARD -->
<section id="user-dashboard">
  <h2>User Dashboard</h2>
  <button onclick="loadRides()">Load Available Rides</button>
  <ul id="userRideList"></ul>
  <button onclick="logout()">Logout</button>
</section>

<!-- DRIVER DASHBOARD -->
<section id="driver-dashboard">
  <h2>Driver Dashboard</h2>
  <button onclick="loadDrivers()">View All Drivers</button>
  <ul id="driverList"></ul>
  <button onclick="logout()">Logout</button>
</section>

<!-- ADMIN DASHBOARD -->
<section id="admin-dashboard">
  <h2>Admin Dashboard</h2>
  <button onclick="loadUsers()">Manage Users</button>
  <ul id="adminUserList"></ul>

  <button onclick="loadDrivers()">Manage Drivers</button>
  <ul id="adminDriverList"></ul>

  <button onclick="loadAnalytics()">View Analytics</button>
  <ul id="analyticsList"></ul>

  <button onclick="logout()">Logout</button>
</section>

<script>
let token = null;
let role = null;

function showSection(sectionId) {
  document.querySelectorAll('section').forEach(sec => sec.style.display = 'none');
  document.getElementById(sectionId).style.display = 'block';
}

async function register() {
  const user = {
    name: document.getElementById("regName").value,
    age: parseInt(document.getElementById("regAge").value),
    email: document.getElementById("regEmail").value,
    password: document.getElementById("regPassword").value,
    isAdmin: document.getElementById("regAdmin").checked
  };

  const res = await fetch("/users/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(user)
  });

  const data = await res.json();
  alert(data.message || data.error);
}

async function login() {
  const res = await fetch("/users/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      email: document.getElementById("loginEmail").value,
      password: document.getElementById("loginPassword").value
    })
  });

  const data = await res.json();
  if (data.token) {
    token = data.token;
    role = data.role;

    if (role === 'admin') showSection('admin-dashboard');
    else if (role === 'driver') showSection('driver-dashboard');
    else showSection('user-dashboard');
  } else {
    alert(data.error);
  }
}

function logout() {
  token = null;
  role = null;
  showSection('auth-section');
}

// USER Functions
async function loadRides() {
  const res = await fetch("/rides");
  const rides = await res.json();
  const list = document.getElementById("userRideList");
  list.innerHTML = '';
  rides.forEach(ride => {
    const li = document.createElement("li");
    li.textContent = `${ride.origin} â†’ ${ride.destination} - RM${ride.fare}`;
    list.appendChild(li);
  });
}

// ADMIN Functions
async function loadUsers() {
  const res = await fetch("/admin/users", {
    headers: { Authorization: `Bearer ${token}` }
  });
  const users = await res.json();
  const list = document.getElementById("adminUserList");
  list.innerHTML = '';
  users.forEach(u => {
    const li = document.createElement("li");
    li.textContent = `${u.name} (${u.email}) - Role: ${u.role}`;
    list.appendChild(li);
  });
}

async function loadAnalytics() {
  const res = await fetch("/analytics/passengers");
  const stats = await res.json();
  const list = document.getElementById("analyticsList");
  list.innerHTML = '';
  stats.forEach(p => {
    const li = document.createElement("li");
    li.textContent = `${p.name}: ${p.totalRides} rides, RM${p.totalFare}, Avg Distance: ${p.avgDistance.toFixed(2)} km`;
    list.appendChild(li);
  });
}

// Shared (Admin & Driver)
async function loadDrivers() {
  const res = await fetch("/drivers");
  const drivers = await res.json();
  const adminList = document.getElementById("adminDriverList");
  const driverList = document.getElementById("driverList");

  adminList.innerHTML = '';
  driverList.innerHTML = '';

  drivers.forEach(d => {
    const li = document.createElement("li");
    li.textContent = `${d.name} - ${d.vehicle || 'No vehicle'} - Rating: ${d.rating || 'N/A'}`;
    if (role === 'admin') adminList.appendChild(li);
    if (role === 'driver') driverList.appendChild(li);
  });
}
</script>

</body>
</html>
